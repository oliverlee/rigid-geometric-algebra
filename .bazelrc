common --enable_bzlmod=false

build --action_env="BAZEL_DO_NOT_DETECT_CPP_TOOLCHAIN=1"
build --color=yes
build --curses=yes
build --incompatible_strict_action_env
build --ui_actions_shown=20
build --progress_in_terminal_title

build --@bazel_clang_format//:binary=@llvm18_toolchain//:clang-format
build --@bazel_clang_format//:config=//:format-config

build --@rules_clang_tidy//:clang-tidy=@llvm18_toolchain//:clang-tidy
build --@rules_clang_tidy//:clang-apply-replacements=@llvm18_toolchain//:clang-apply-replacements
build --@rules_clang_tidy//:config=//:tidy-config

build:remote --remote_cache=grpcs://oliverlee.buildbuddy.io
build:remote --remote_download_outputs=minimal
build:remote --remote_timeout=3600
build:remote --remote_cache_compression
build:remote --remote_build_event_upload=minimal
build:remote --noslim_profile
build:remote --experimental_profile_include_target_label
build:remote --experimental_profile_include_primary_output
build:remote --nolegacy_important_outputs

test --test_verbose_timeout_warnings

coverage --combined_report=lcov
coverage --experimental_generate_llvm_lcov
coverage --instrumentation_filter=//rigid_geometric_algebra

# generate and retain gcov files with the llvm toolchain
#
# https://github.com/bazelbuild/bazel/blob/master/tools/test/collect_coverage.sh
# https://github.com/bazelbuild/bazel/blob/master/tools/test/collect_cc_coverage.sh
#
# disable use of llvm profdata
coverage:gcov --experimental_generate_llvm_lcov=false
# replace default coverage flags to generate gcov instead of profdata
#
# https://clang.llvm.org/docs/SourceBasedCodeCoverage.html#compiling-with-coverage-enabled
# https://llvm.org/docs/CommandGuide/llvm-cov.html#id1
# https://github.com/bazel-contrib/toolchains_llvm/blob/4ab573b1b87a57791ef2f9ccee71cbad80a2abb9/toolchain/cc_toolchain_config.bzl#L264-L266
coverage:gcov --features=-coverage
coverage:gcov --copt=--coverage
coverage:gcov --linkopt=--coverage
#coverage:gcov --test_env=COVERAGE_GCOV_PATH=./external/llvm18_toolchain_llvm/bin/llvm-cov
coverage:gcov --test_env=COVERAGE_GCOV_PATH=/Users/oliver/repos/rigid-geometric-algebra/gcov-wrapper.bash
# https://github.com/bazelbuild/bazel/issues/23719
coverage:gcov --test_env=GCOV_PREFIX_STRIP=10
#  https://github.com/bazelbuild/bazel/issues/23718
# https://github.com/bazelbuild/bazel/issues/20041#issuecomment-1805195618
coverage:gcov --keep_going
coverage:gcov --experimental_fetch_all_coverage_outputs

coverage:gcov --test_env=LCOV_MERGER=""

# don't use intermediate format
coverage:gcov --test_env=COVERAGE_GCOV_OPTIONS="--branch-counts --branch-probabilities --all-blocks --demangled-names --hash-filenames"
# GCOV options
# --branch-counts --branch-probabilities --all-blocks --demangled-names --hash-filenames

# enable verbose coverage output
coverage:verbose-coverage --test_env=VERBOSE_COVERAGE=1
coverage:verbose-coverage --test_output=all

try-import %workspace%/user.bazelrc
